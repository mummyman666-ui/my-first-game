# ゲーム仕様書 / 開発マニュアル

このファイルは、リポジトリ内の単一ファイル HTML ゲーム群（例: `game9.html`）を素早く理解し、修正・拡張するための実務的な仕様書です。


## 概要（ビッグピクチャ）

- 種類: 静的な単一ファイル HTML ゲーム群。各ファイルに HTML/CSS/JS をインラインで持つ。
- 実行方法: ブラウザでファイルを直接開くか、ローカル静的サーバ（例: VSCode Live Server / `npx serve`）でホストして確認。

## 主要なファイル（例）

- `game9.html` — フル実装のサンプル。Canvas 描画、UI、ゲームループ、マップ生成、エンティティ群（Player/Enemy/Projectile など）を含む。
- その他の `game1_1.html`, `game1_2.html`, `game2.html` ... は同様の一ファイル構成。

## 実行 / デバッグ手順

1. エディタで対象ファイル（例: `game9.html`）を開く。

1. ブラウザでファイルを開く（ダブルクリック）またはローカル静的サーバでホスト。

    - 推奨: VSCode の Live Server 拡張を使うとホットリロードが便利。

1. ブラウザ DevTools の Console でグローバル `game` オブジェクトを確認する（例: `game.player`, `game.map`）。

1. オーディオはユーザー操作がないと初期化されない（AudioContext の制約）。音をテストする場合はクリックしてから操作すること。

## 操作方法（`game9.html` の例）

- マウス移動: 自機移動
- マウスホイール: 照準回転
- 左クリック: 攻撃
- 右クリック: タワー設置メニュー（未実装の部分あり）
- Shift / Space: ダッシュ
- Rキー: リスタート

## コード構造と主要パターン

- 単一の `Game` クラスがエントリ／ループを管理。
  - 初期化: `Game.init()`
  - メインループ: `Game.gameLoop()`（`requestAnimationFrame`）
  - UI 更新: `Game.updateUI()`
  - モーダル表示: `Game.showUpgradeModal()` 等
- グローバル状態: `player`, `map`, `enemies`, `projectiles`, `towers` などはファイル内グローバル配列／変数として共有。
- エンティティはクラス単位で定義（`Player`, `Enemy`, `Projectile`, `Tower`, `Map`, `Particle`, `Resource`）。
- マップはタイル格子で、ワールドはループ（端から反対側へワープ）する実装。

## 重要な DOM / ID（編集時に参照すること）

- `#gameCanvas` — メイン描画用 canvas
- `#minimap` — ミニマップ用 canvas
- `#hp-bar`, `#xp-bar` — UI プログレスバー
- `#tutorial-modal`, `#upgrade-modal`, `#game-over-modal` — モーダル UI

## 音声・オーディオの扱い

- `audioCtx` は遅延初期化される（`mousedown` イベント時に `Game.initAudio()` を呼ぶ）。
- 修正時はブラウザのユーザー操作制約により、DevTools で自動テストしにくい場合がある。手動クリックで検証する。

## よくある変更シナリオ（実践例）

- 新しいアップグレードを追加する: `UPGRADE_POOL` にオブジェクトを追加。`apply` の中で `player`（または p）オブジェクトを操作する。
- 新しい敵タイプを追加する: `Enemy` クラス内の分岐や `Game.spawnEnemy()` の生成ロジックを拡張。
- タワーの挙動を追加: `Tower` クラスを拡張し、`Game` 内の `towers` 配列に追加。UI を追加する場合は対応する DOM ID を作る。

## 編集時の注意点 / 落とし穴

- グローバル変数依存: 変数の初期化順序に注意（`game` を参照するコードがファイル末尾で初期化される）。
- マップのループ: 座標系がワールドループを前提にしているため、座標クリッピングやオフセット計算を壊さないこと。
- 大きなリファクタ（モジュール化など）は、まず `game` の生成順（DOM が準備されていること）を確保してから行う。

## 推奨の小さな改善タスク（PR 向け）

1. 外部のサウンドファイルを読み込む場合は、`loadSounds()` にフェッチ／AudioBuffer 取り込みを実装。
2. `Tower` のスロー効果を正しく適用・解除する仕組みを追加する（現状コメントで留めてある）。
-3. `projectiles` と `enemyProjectiles` の寿命・削除処理をユーティリティ化して重複を削る。


## トラブルシューティング（確認ポイント）

- 画面が真っ黒／何も描画されない: `canvas` サイズと `Game.resizeCanvas()` を確認。
- `game` が未定義のエラー: ファイルの末尾で `const game = new Game();` が存在するか確認し、DOMContentLoaded のタイミング問題がないか検証。
- 音が鳴らない: ブラウザの自動再生制限により AudioContext がサスペンドされる場合がある。クリックで初期化すること。

---
この仕様書は最小限の運用ドキュメントです。ファイル毎の詳細なサマリ（`game1_1.html` など）を自動生成して追記することもできます。ご希望があれば次に自動サマリを追加します。

